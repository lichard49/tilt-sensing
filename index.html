<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hello Bulma!</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.2/css/bulma.min.css">
    <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
  </head>

  <body>
  <section class="section">
    <div class="container">
      <h1 class="title">
        Complementary Filter Demo
      </h1>
      <p class="subtitle">
        Accel + Gyro = Tilt
      </p>

      <hr>

      <h2 class="title is-4">Sensors</h2>

      <table class="table is-fullwidth">
        <thead>
          <tr>
            <th></th>
            <th>X</th>
            <th>Y</th>
            <th>Z</th>
            <th>Mag</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th>Accelerometer</th>
            <td id="accel-x">X</td>
            <td id="accel-y">Y</td>
            <td id="accel-z">Z</td>
            <td id="accel-mag">Mag</td>
          </tr>
          <tr>
            <th>Gyroscope</th>
            <td id="gyro-x">X</td>
            <td id="gyro-y">Y</td>
            <td id="gyro-z">Z</td>
            <td id="gyro-mag">Mag</td>
          </tr>
        </tbody>
      </table>

      <hr>

      <h2 class="title is-4">Calibration</h2>

      <div class="buttons">
        <button id="calibrate" class="button is-primary" disabled>Calibrate</button>
      </div>

      <table class="table is-fullwidth">
        <thead>
          <tr>
            <th></th>
            <th>X</th>
            <th>Y</th>
            <th>Z</th>
            <th>Mag</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th>Accel. Bias</th>
            <td id="accel-bias-x">X</td>
            <td id="accel-bias-y">Y</td>
            <td id="accel-bias-z">Z</td>
            <td id="accel-bias-mag">Mag</td>
          </tr>
          <tr>
            <th>Gyro. Bias</th>
            <td id="gyro-bias-x">X</td>
            <td id="gyro-bias-y">Y</td>
            <td id="gyro-bias-z">Z</td>
            <td id="gyro-bias-mag">Mag</td>
          </tr>
          <tr>
            <th>Accel. Noise</th>
            <td id="accel-noise-x">X</td>
            <td id="accel-noise-y">Y</td>
            <td id="accel-noise-z">Z</td>
            <td id="accel-noise-mag">Mag</td>
          </tr>
          <tr>
            <th>Gyro. Noise</th>
            <td id="gyro-noise-x">X</td>
            <td id="gyro-noise-y">Y</td>
            <td id="gyro-noise-z">Z</td>
            <td id="gyro-noise-mag">Mag</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>

  <script type="text/javascript">
    function average(array) {
      var average = 0;
      for (var i = array.length - 1; i >= 0; i--) {
        average += array[i];
      }
      return average / array.length;
    }


    function magnitude(x, y, z) {
      return Math.sqrt(x ** 2 + y ** 2 + z ** 2);
    }


    function rootMeanSquare(array) {
      var rootMeanSquare = 0;
      for (var i = array.length - 1; i >= 0; i--) {
        rootMeanSquare += array[i] ** 2;
      }
      return Math.sqrt(rootMeanSquare / array.length);
    }


    function makeSensorAxis(sensor_prefix, axis_suffix) {
      return {
        calibrate: [],
        out: document.getElementById(sensor_prefix + '-' +
          axis_suffix),
        bias_out: document.getElementById(sensor_prefix + '-bias-' +
          axis_suffix),
        noise_out: document.getElementById(sensor_prefix +
          '-noise-' + axis_suffix)
      };
    }


    function setupSensor(sensor_name, sensor_constructor,
      sensor_prefix) {

      var sensor = {};

      if (sensor_name in window) {
        sensor.sensor = new sensor_constructor();

        sensor.axes = {
          x: makeSensorAxis(sensor_prefix, 'x'),
          y: makeSensorAxis(sensor_prefix, 'y'),
          z: makeSensorAxis(sensor_prefix, 'z'),
          mag: makeSensorAxis(sensor_prefix, 'mag')
        };

        addSensorHandler(sensor);
        sensor.sensor.start();

        return sensor;
      } else {
        return null;
      }
    }


    function addSensorHandler(sensor_wrapper) {
      var sensor = sensor_wrapper.sensor;

      sensor.addEventListener('reading', function() {
        // calculate magnitude of 3 axes signal        
        sensor.mag = magnitude(sensor.x, sensor.y, sensor.z);

        for (var axis in sensor_wrapper.axes) {
          // update front end
          sensor_wrapper.axes[axis].out.innerHTML =
            sensor[axis].toFixed(2);

          // accumulate samples when calibrating
          if (calibrating) {
            sensor_wrapper.axes[axis].calibrate.push(sensor[axis]);
          }
        }
      });
    }


    function setButton(button, disabled) {
      button.disabled = disabled;
      if (disabled) {
        button.classList.add('is-loading');
      } else {
        button.classList.remove('is-loading');
      }
    }


    function showBias(sensor_wrapper) {
      for (var axis in sensor_wrapper.axes) {
        // update front end
        sensor_wrapper.axes[axis].bias_out.innerHTML =
          average(sensor_wrapper.axes[axis].calibrate).toFixed(2);
      }
    }


    function showNoise(sensor_wrapper) {
      for (var axis in sensor_wrapper.axes) {
        // update front end
        sensor_wrapper.axes[axis].noise_out.innerHTML =
          rootMeanSquare(sensor_wrapper.axes[axis].calibrate)
          .toFixed(2);
      }
    }


    var accel = setupSensor('Accelerometer', Accelerometer, 'accel');
    var gyro = setupSensor('Gyroscope', Gyroscope, 'gyro');
    var calibrating = false;


    if (accel != null && gyro != null) {
      // enable calibrate button
      var calibrate_button = document.getElementById('calibrate');
      setButton(calibrate_button, false);

      calibrate_button.addEventListener('click', function() {
        // disable calibrate button while recording
        setButton(calibrate_button, true);
        calibrating = true;

        window.setTimeout(function() {
          // enable button again when done recording
          setButton(calibrate_button, false);
          calibrating = false;

          // update front end with bias measures
          showBias(accel);
          showBias(gyro);
          showNoise(accel);
          showNoise(gyro);
        }, 5000);
      });
    }
  </script>
  </body>
</html>